<script>
  let map;

  function initMap() {
    const ucrCoords = { lat: 33.9737, lng: -117.3281 };

    const mapRange = {
      center: ucrCoords,
      zoom: 14,
      restriction: {
        latLngBounds: {
          north: 33.9800,
          south: 33.9670,
          west: -117.3400,
          east: -117.3190,
        },
        strictBounds: true,
      },
    };

    map = new google.maps.Map(document.getElementById("map"), mapRange);

    // Load existing pins from localStorage
    loadPins();

    // Allow users to add markers on click
    map.addListener("click", function (event) {
      placeMarker(event.latLng);
    });

    // Periodically remove expired pins
    setInterval(removeExpiredPins, 60000); // Run every minute
  }

  function placeMarker(location) {
    const experienceType = prompt("Enter experience type (Positive or Negative):");
    const title = prompt("Enter Title:");
    const description = prompt("Enter what happened:");

    if (title && description) {
      const timestamp = new Date().toLocaleString();
      const expirationTime = Date.now() + 5 * 60 * 60 * 1000; // 5 hours from now

      // Decide marker color based on experience type
      let pinType = "negative";
      let iconUrl = "https://maps.google.com/mapfiles/ms/icons/red-dot.png";

      if (experienceType && experienceType.toLowerCase().includes("positive")) {
        pinType = "positive";
        iconUrl = "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
      }

      // Create the marker with the chosen icon
      const marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: iconUrl,
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div>
            <strong style="font-size: 1.2em;">${title}</strong>
            <p>${description}</p>
            <p><small>${timestamp}</small></p>
          </div>
        `,
      });

      marker.addListener("click", function () {
        infoWindow.open(map, marker);
      });

      // Store pin in localStorage
      storePin(location, title, description, timestamp, expirationTime, pinType);

      // Show on the right-hand info panel
      addMarkerInfo(title, description, timestamp);
    }
  }

  function storePin(location, title, description, timestamp, expirationTime, pinType) {
    const pins = JSON.parse(localStorage.getItem("pins")) || [];
    pins.push({
      lat: location.lat(),
      lng: location.lng(),
      title,
      description,
      timestamp,
      expirationTime,
      type: pinType,
    });
    localStorage.setItem("pins", JSON.stringify(pins));
  }

  function loadPins() {
    const pins = JSON.parse(localStorage.getItem("pins")) || [];
    pins.forEach(pin => {
      if (Date.now() < pin.expirationTime) {
        const location = new google.maps.LatLng(pin.lat, pin.lng);

        let iconUrl = "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
        if (pin.type === "positive") {
          iconUrl = "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
        }

        const marker = new google.maps.Marker({
          position: location,
          map: map,
          icon: iconUrl,
        });

        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div>
              <strong style="font-size: 1.2em;">${pin.title}</strong>
              <p>${pin.description}</p>
              <p><small>${pin.timestamp}</small></p>
            </div>
          `,
        });

        marker.addListener("click", function () {
          infoWindow.open(map, marker);
        });

        // Populate the right-hand info panel
        addMarkerInfo(pin.title, pin.description, pin.timestamp);
      }
    });
  }

  function removeExpiredPins() {
    const pins = JSON.parse(localStorage.getItem("pins")) || [];
    const updatedPins = pins.filter(pin => Date.now() < pin.expirationTime);
    localStorage.setItem("pins", JSON.stringify(updatedPins));
  }

  function addMarkerInfo(title, description, timestamp) {
    const infoContainer = document.getElementById("info");
    const markerInfo = document.createElement("div");
    markerInfo.className = "marker-info";
    markerInfo.innerHTML = `
      <strong>${title}</strong>
      <p>${description}</p>
      <p><small>${timestamp}</small></p>
    `;
    infoContainer.insertBefore(markerInfo, infoContainer.firstChild);

    // Keep only the 4 most recent items
    const markerInfos = infoContainer.getElementsByClassName("marker-info");
    if (markerInfos.length > 4) {
      infoContainer.removeChild(markerInfos[markerInfos.length - 1]);
    }
  }
</script>
